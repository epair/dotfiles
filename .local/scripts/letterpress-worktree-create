#!/usr/bin/env bash

# Create a new letterpress worktree with tmux prompts

LETTERPRESS_DIR="$HOME/code/postie/letterpress-app"

# Function to create worktree with given parameters
create_worktree() {
    local input="$1"
    
    # Parse input: "worktree_name [prefix]"
    # If prefix is not provided, use default
    local worktree_name="${input%% *}"
    local remaining="${input#* }"
    
    if [[ "$remaining" == "$input" ]]; then
        # No space found, so no prefix was provided
        local branch_prefix="ep/"
    else
        # Prefix was provided
        local branch_prefix="$remaining"
    fi
    
    if [[ -z "$worktree_name" ]]; then
        tmux display-message -d 2000 "Error: Worktree name cannot be empty"
        return 1
    fi
    
    # Change to letterpress directory
    cd "$LETTERPRESS_DIR" || {
        tmux display-message -d 2000 "Error: Cannot access letterpress directory"
        return 1
    }
    
    # Create the worktree
    tmux display-message "Creating worktree '$worktree_name' with branch prefix '$branch_prefix'..."
    
    if WORKTREE_PREFIX="$branch_prefix" worktree-manager add "$worktree_name"; then
        # Success - switch to the new worktree session
        # Small delay to ensure worktree is fully created
        sleep 0.5
        tmux-sessionizer "$LETTERPRESS_DIR/$worktree_name"
    else
        tmux display-message -d 2000 "Error: Failed to create worktree '$worktree_name'"
    fi
}

# If called with arguments, execute the creation
if [[ $# -ge 1 ]]; then
    create_worktree "$*"
else
    # Show single prompt for both inputs
    tmux command-prompt -p "Enter: worktree-name [prefix] (default prefix: ep/):" \
        "run-shell 'letterpress-worktree-create %%'"
fi