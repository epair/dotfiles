#!/usr/bin/env bash

# Switch to a git worktree
# Works with any git repository that has a .bare directory

# Function to find git root with .bare directory
find_git_worktree_root() {
    local current_dir="$PWD"
    
    # Check current directory and parent directories for .bare
    while [[ "$current_dir" != "/" ]]; do
        if [[ -d "$current_dir/.bare" ]]; then
            echo "$current_dir"
            return 0
        fi
        current_dir=$(dirname "$current_dir")
    done
    
    return 1
}

# Find the worktree root
WORKTREE_ROOT=$(find_git_worktree_root)

if [[ -z "$WORKTREE_ROOT" ]]; then
    tmux display-message -d 2000 "Error: Not in a git worktree with .bare directory"
    exit 1
fi

# Get list of worktrees
get_worktrees() {
    cd "$WORKTREE_ROOT" || return 1
    find . -maxdepth 1 -type d ! -name "." ! -name ".*" -exec basename {} \; | sort
}

# If called with argument, switch to that worktree
if [[ $# -eq 1 ]]; then
    worktree_name="$1"
    worktree_path="$WORKTREE_ROOT/$worktree_name"
    
    if [[ -d "$worktree_path" ]]; then
        tmux-sessionizer "$worktree_path"
    else
        tmux display-message -d 2000 "Error: Worktree '$worktree_name' not found"
    fi
    exit 0
fi

# Build menu of worktrees
worktrees=$(get_worktrees)

if [[ -z "$worktrees" ]]; then
    tmux display-message "No worktrees found"
    exit 0
fi

# Get repository name for display
REPO_NAME=$(basename "$WORKTREE_ROOT")

# Create menu items
menu_items=("-T" "Switch to Worktree - $REPO_NAME" "" "" "")

# Counter for hotkeys
index=1

while IFS= read -r worktree; do
    if [[ -n "$worktree" ]]; then
        worktree_path="$WORKTREE_ROOT/$worktree"
        
        # Determine hotkey (only for first 9 items)
        hotkey=""
        if [[ $index -le 9 ]]; then
            hotkey="$index"
        fi
        
        # Check if session exists
        if tmux has-session -t "$worktree" 2>/dev/null; then
            if [[ -n "$hotkey" ]]; then
                menu_items+=("$worktree •" "$hotkey" "run-shell 'tmux-sessionizer \"$worktree_path\"'")
            else
                menu_items+=("$worktree •" "" "run-shell 'tmux-sessionizer \"$worktree_path\"'")
            fi
        else
            if [[ -n "$hotkey" ]]; then
                menu_items+=("$worktree" "$hotkey" "run-shell 'tmux-sessionizer \"$worktree_path\"'")
            else
                menu_items+=("$worktree" "" "run-shell 'tmux-sessionizer \"$worktree_path\"'")
            fi
        fi
        
        ((index++))
    fi
done <<< "$worktrees"

# Display the menu
tmux display-menu -x C -y C "${menu_items[@]}"